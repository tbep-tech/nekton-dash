---
title: "TAMPA BAY NEKTON INDEX DASHBOARD"
output: 
  flexdashboard::flex_dashboard:
     logo: www/tarponlogo.png
     social: menu
     source_code: "https://github.com/tbep-tech/nekton-dash"
runtime: shiny
css: styles.css
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

library(flexdashboard)
library(tidyverse)
library(tbeptools)
# devtools::load_all('../tbeptools')
library(mapedit)
library(mapview)
library(leaflet.extras)
library(sf)
library(reactable)
library(shinydashboard)
library(plotly)
library(shinyWidgets)
library(extrafont)

# # style file
# styles <- readLines('https://raw.githubusercontent.com/tbep-tech/css-styling/master/styles.css')
# writeLines(styles, 'styles.css')

data(tbniscr)

fml <- 'Lato Light'
maxyr <- 2019
perc <- c(32, 46)
cols <- c('red', 'yellow', 'green')

# annually averaged data
tbniyrs <- tbniscr %>%
  select(Reference, Year, TBNI_Score, matches('Score')) %>% 
  gather('var', 'val', -Reference, -Year) %>% 
  group_by(Reference, Year, var) %>% 
  summarise(val = mean(val, na.rm = T)) %>% 
  spread(var, val) %>% 
  ungroup %>% 
  mutate(
    action = findInterval(TBNI_Score, perc),
    outcome = factor(action, levels = c('0', '1', '2'), labels = c('red', 'yellow', 'green')),
    outcome = as.character(outcome),
    action = factor(action, levels = c('0', '1', '2'), labels = c('On Alert', 'Caution', 'Stay the Course'))
  )

avedat <- anlz_tbniave(tbniscr) 
```

```{r reactives}
# site attainment map
attmap <- reactive({
  
  # inputs
  yrsel <- input$yrsel

  # site scores
  toplo <- tbniyrs %>% 
    filter(Year %in% yrsel) %>% 
    select(Reference, TBNI_Score, action, outcome) %>% 
    right_join(fimstations, ., by = 'Reference')
  
  # segment averages
  attyr <- avedat %>% 
    filter(Year %in% yrsel) %>% 
    left_join(tbseg, ., by = 'bay_segment') 

  # map with custom legends
  mapview(attyr, fill = F, homebutton = F, popup = NULL, legend = F) %>% 
    .@map %>% 
    clearMarkers() %>% 
    leafem::removeMouseCoordinates() %>%
    addPolygons(
      data = attyr, 
      stroke = T, 
      color = 'grey', 
      weight = 1, 
      layerId = ~long_name, 
      fillColor = ~outcome, 
      fillOpacity = 0.3,
      label = ~paste0(bay_segment, ': ', long_name, ', Action: ', action, ' (', outcome, ')')
    ) %>% 
    addCircleMarkers(
      data = toplo, 
      layerId = ~Reference,
      stroke = TRUE,
      color = 'black',
      fill = TRUE,
      fillColor = ~outcome,
      weight = 1,
      fillOpacity = 1,
      radius= 4,#~scales::rescale(val, from = scls, to = c(5, 20)),
      label = ~paste0('Station ', Reference, ' (TBNI: ', round(TBNI_Score, 1), ', action: ', action)
    ) %>% 
    addLegend("topright", labels = c("Stay the Course", "Caution", "On Alert"), colors = rev(cols), title = "Bay segment/site <br>matrix outcomes", opacity = 1)
  
})
```

```{r map}

```

```{r downloadhandlers}

```

OVERVIEW
===========================================================

Column {.tabset .tabset-fade data-width=650}
-----------------------------------------------------------------------

### USING THE DASHBOARD

<div class = "row">
<div class = "col-md-2"></div>
<div class = "col-md-8">

#### WELCOME TO THE TAMPA BAY NEKTON INDEX DASHBOARD!

```{r, echo = F, out.width = '100%', fig.align = 'center'}
knitr::include_graphics('www/bannerimage.png')
```

The Tampa Bay Nekton Index (TBNI) is a multimetric assessment method that quantifies the ecological health of the nekton community in Tampa Bay. The index provides a complementary approach to evaluating environmental condition that is supported by other assessment methods currently available for Tampa Bay (e.g., water quality report card, Benthic index, etc.).

</div>
<div class = "col-md-2"></div>
</div>

### METHODS

### DOWNLOAD DATA

1. BAY SEGMENT RESULTS
===========================================================

Column {.tabset .tabset-fade data-width=275}
-----------------------------------------------------------------------

### MATRIX RESULTS

### Using this tab

Column {data-width=500}
-----------------------------------------------------------------------

### RESULTS BY YEAR

```{r}
output$attmap <- renderLeaflet({attmap()})
fillCol(flex = c(NA, 1),
  column(12,
    column(6,
      sliderInput('yrsel', 'Select year:', min = 1998, max = maxyr, value = maxyr, step = 1, sep = '', width = '200%', animate = T),
    )
  ),
  leafletOutput('attmap')
)
```

2 SITE TRENDS
===========================================================

Column {.tabset .tabset-fade data-width=275}
-----------------------------------------------------------------------

### MAP SELECTION

### Using this tab


Column {data-width=500}
-----------------------------------------------------------------------

### PLOT
